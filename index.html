<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PMGâ„¢ EDU | All Courses</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#FFD700">

<style>
body {margin:0;font-family:'Playfair Display', serif;background:#0f0f0f;color:#f0f0f0;text-align:center;padding:20px;}
h1{color:#FFD700;font-size:2.5em;}
.section{background:#1b1b1b;padding:20px;border-radius:12px;max-width:900px;margin:20px auto;}
button{padding:12px 20px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
.paper-btn{background:#2563eb;color:#fff;width:100%;margin:5px 0}
.disabled{opacity:0.4;pointer-events:none}
.hidden{display:none}
iframe {border:none;}
</style>
</head>

<body>

<h1>PMGâ„¢ EDU</h1>
<p><b>Demo / Paid Academic Resources</b></p>

<!-- AUTH -->
<div id="auth" class="section">
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="Password"><br><br>
  <button onclick="login()">Login</button>
  <button onclick="register()">Register</button>
</div>

<!-- USER -->
<div id="userPanel" class="section hidden">
  <p id="statusText"></p>
  <button onclick="markPaid()">I PAID K20</button>
</div>

<!-- COURSES -->
<div id="content" class="section hidden">
  <h3>Courses</h3>
  <button class="paper-btn" onclick="openPDF()">Open Sample PDF</button>
  <div id="pdfViewer" class="hidden" style="margin-top:20px;">
    <iframe id="pdfFrame" width="100%" height="600px"></iframe>
  </div>
</div>

<!-- ADMIN -->
<div id="adminPanel" class="section hidden">
  <h2>Admin Dashboard</h2>
  <div id="pendingUsers"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* ðŸ”´ REPLACE WITH YOUR FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* REGISTER USER */
window.register = async () => {
  const emailVal = email.value;
  const passwordVal = password.value;
  if(!emailVal || !passwordVal){ alert("Enter email and password"); return; }
  const res = await createUserWithEmailAndPassword(auth, emailVal, passwordVal);
  await setDoc(doc(db,"users",res.user.uid),{
    email: emailVal,
    role: "user",
    paymentStatus: "trial"
  });
  alert("Registered! Login now.");
};

/* LOGIN USER */
window.login = async () => {
  const emailVal = email.value;
  const passwordVal = password.value;
  if(!emailVal || !passwordVal){ alert("Enter email and password"); return; }
  await signInWithEmailAndPassword(auth,emailVal,passwordVal);
};

/* AUTH STATE CHANGE */
onAuthStateChanged(auth, async user=>{
  if(!user) return authDiv(true);

  authDiv(false);

  const refUser = doc(db,"users",user.uid);
  const snap = await getDoc(refUser);
  if(!snap.exists()){ alert("User record not found!"); return; }
  const data = snap.data();

  if(data.role==="admin"){
    showAdmin();
  }else{
    showUser(data.paymentStatus);
  }
});

function authDiv(show){ document.getElementById("auth").classList.toggle("hidden",!show); }

/* SHOW USER PANEL */
function showUser(status){
  userPanel.classList.remove("hidden");
  content.classList.remove("hidden");

  if(status==="trial"){
    statusText.innerText="Demo Mode (Locked)";
    content.classList.add("disabled");
  }
  else if(status==="pending"){
    statusText.innerText="Payment Pending Approval";
    content.classList.add("disabled");
  }
  else if(status==="approved"){
    statusText.innerText="Full Access Granted";
    content.classList.remove("disabled");
  }
}

/* MARK PAID BUTTON */
window.markPaid = async ()=>{
  const u = auth.currentUser;
  await updateDoc(doc(db,"users",u.uid),{paymentStatus:"pending"});
  alert("Payment marked pending. Await admin approval.");
};

/* ADMIN DASHBOARD */
async function showAdmin(){
  adminPanel.classList.remove("hidden");
  userPanel.classList.add("hidden");
  content.classList.add("hidden");

  const q = await getDocs(collection(db,"users"));
  pendingUsers.innerHTML="<h3>Users</h3>";

  q.forEach(d=>{
    const u=d.data();
    pendingUsers.innerHTML+=`
      <p>
        <b>${u.email}</b><br>
        Status: ${u.paymentStatus}<br>
        Role: ${u.role}<br>
        ${u.paymentStatus==="pending" ? `<button onclick="approve('${d.id}')">Approve</button>` : ""}
        <button onclick="removeUser('${d.id}')">Delete</button>
      </p><hr>
    `;
  });
}

/* APPROVE USER */
window.approve = async(id)=>{
  await updateDoc(doc(db,"users",id),{paymentStatus:"approved"});
  alert("User approved! They now have full access.");
  showAdmin();
};

/* DELETE USER */
window.removeUser = async(id)=>{
  await deleteDoc(doc(db,"users",id));
  alert("User deleted!");
  showAdmin();
};

/* OPEN PDF VIEW-ONLY */
window.openPDF = async ()=>{
  const u = auth.currentUser;
  const snap = await getDoc(doc(db,"users",u.uid));
  if(snap.exists() && snap.data().paymentStatus==="approved"){
    const pdfRef = ref(storage, 'courses/sample.pdf'); // make sure PDF is uploaded here
    const url = await getDownloadURL(pdfRef);
    document.getElementById('pdfViewer').classList.remove('hidden');
    document.getElementById('pdfFrame').src = url;
  } else{
    alert("Access denied. Please pay and wait for approval.");
  }
};
</script>

</body>
</html>
