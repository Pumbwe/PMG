<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PMGâ„¢ EDU | All Courses</title>

<style>
body {
  margin:0;
  font-family: Arial, sans-serif;
  background:#0f0f0f;
  color:#f0f0f0;
  text-align:center;
  padding:20px;
}
h1 { color:#FFD700; }
.section {
  background:#1b1b1b;
  padding:20px;
  border-radius:12px;
  max-width:900px;
  margin:20px auto;
}
button {
  padding:12px 20px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}
.paper-btn {
  background:#2563eb;
  color:#fff;
  width:100%;
  margin:5px 0;
}
.hidden { display:none; }
.disabled { opacity:0.4; pointer-events:none; }
iframe { border:none; }
input {
  padding:10px;
  width:80%;
  max-width:300px;
}
</style>
</head>

<body>

<h1>PMGâ„¢ EDU</h1>
<p><b>Demo / Paid Academic Resources</b></p>

<!-- AUTH -->
<div id="auth" class="section">
  <input id="email" placeholder="Email"><br><br>
  <input id="password" type="password" placeholder="Password"><br><br>
  <button onclick="login()">Login</button>
  <button onclick="register()">Register</button>
</div>

<!-- USER PANEL -->
<div id="userPanel" class="section hidden">
  <p id="statusText"></p>
  <button id="payBtn" onclick="markPaid()">
    Pay K20 (Airtel: 0775302886 / MTN: 0768497390)
  </button>
</div>

<!-- CONTENT -->
<div id="content" class="section hidden">
  <h3>MA110 â€“ Past Papers</h3>
  <button class="paper-btn" onclick="openPDF()">Open MA110 2019</button>

  <div id="pdfViewer" class="hidden" style="margin-top:20px;">
    <iframe id="pdfFrame" width="100%" height="600px"></iframe>
  </div>
</div>

<!-- ADMIN -->
<div id="adminPanel" class="section hidden">
  <h2>Admin Dashboard</h2>
  <div id="pendingUsers"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  collection,
  getDocs,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”´ PUT YOUR REAL FIREBASE CONFIG HERE */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* UI HELPERS */
function showAuth(){
  authDiv.classList.remove("hidden");
  userPanel.classList.add("hidden");
  content.classList.add("hidden");
  adminPanel.classList.add("hidden");
}
function showUserUI(){
  authDiv.classList.add("hidden");
  userPanel.classList.remove("hidden");
  content.classList.remove("hidden");
  adminPanel.classList.add("hidden");
}
function showAdminUI(){
  authDiv.classList.add("hidden");
  userPanel.classList.add("hidden");
  content.classList.add("hidden");
  adminPanel.classList.remove("hidden");
}

const authDiv = document.getElementById("auth");

/* REGISTER */
window.register = async () => {
  if(!email.value || !password.value){
    alert("Enter email and password");
    return;
  }
  const res = await createUserWithEmailAndPassword(auth, email.value, password.value);
  await setDoc(doc(db,"users",res.user.uid),{
    email: email.value,
    role: "user",
    paymentStatus: "trial",
    trialCount: 5
  });
  alert("Registered! Login now.");
};

/* LOGIN */
window.login = async () => {
  await signInWithEmailAndPassword(auth, email.value, password.value);
};

/* AUTH STATE */
onAuthStateChanged(auth, async user=>{
  if(!user){
    showAuth();
    return;
  }
  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()){
    alert("User data missing");
    return;
  }
  const data = snap.data();
  if(data.role === "admin"){
    showAdmin();
  } else {
    showUser(data);
  }
});

/* SHOW USER */
function showUser(data){
  showUserUI();
  pdfViewer.classList.add("hidden");

  if(data.paymentStatus === "trial"){
    if(data.trialCount > 0){
      statusText.innerText = `Trial Mode (${data.trialCount} views left)`;
      payBtn.classList.add("hidden");
      content.classList.remove("disabled");
    } else {
      statusText.innerText = "Trial finished â€” Please pay";
      payBtn.classList.remove("hidden");
      content.classList.add("disabled");
    }
  }
  else if(data.paymentStatus === "pending"){
    statusText.innerText = "Payment pending approval";
    payBtn.classList.add("hidden");
    content.classList.add("disabled");
  }
  else if(data.paymentStatus === "approved"){
    statusText.innerText = "Full Access Granted";
    payBtn.classList.add("hidden");
    content.classList.remove("disabled");
    loadPDF();
  }
}

/* OPEN PDF */
window.openPDF = async ()=>{
  const user = auth.currentUser;
  const refUser = doc(db,"users",user.uid);
  const snap = await getDoc(refUser);
  const data = snap.data();

  if(data.paymentStatus === "approved"){
    loadPDF();
  }
  else if(data.paymentStatus === "trial" && data.trialCount > 0){
    await updateDoc(refUser,{ trialCount: data.trialCount - 1 });
    showUser({ ...data, trialCount: data.trialCount - 1 });
    loadPDF();
  }
  else{
    alert("Trial finished. Pay K20 to continue.");
  }
};

/* LOAD PDF (GOOGLE VIEWER + GITHUB) */
function loadPDF(){
  const url =
    "https://docs.google.com/gview?url=https://pumbwe.github.io/PMG/past-papers/MA110/MA110-2019.pdf&embedded=true";
  pdfViewer.classList.remove("hidden");
  pdfFrame.src = url;
}

/* MARK PAID */
window.markPaid = async ()=>{
  const u = auth.currentUser;
  await updateDoc(doc(db,"users",u.uid),{ paymentStatus:"pending" });
  alert("Payment marked pending. Await admin approval.");
};

/* ADMIN */
async function showAdmin(){
  showAdminUI();
  const q = await getDocs(collection(db,"users"));
  pendingUsers.innerHTML = "<h3>Users</h3>";
  q.forEach(d=>{
    const u = d.data();
    pendingUsers.innerHTML += `
      <p>
        <b>${u.email}</b><br>
        Status: ${u.paymentStatus}<br>
        <button onclick="approve('${d.id}')">Approve</button>
        <button onclick="removeUser('${d.id}')">Delete</button>
      </p><hr>`;
  });
}

window.approve = async(id)=>{
  await updateDoc(doc(db,"users",id),{ paymentStatus:"approved" });
  showAdmin();
};
window.removeUser = async(id)=>{
  await deleteDoc(doc(db,"users",id));
  showAdmin();
};

/* DISABLE RIGHT CLICK */
document.addEventListener("contextmenu", e => e.preventDefault());
</script>

</body>
  </html>
